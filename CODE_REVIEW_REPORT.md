# é¡¹ç›®ä»£ç å®¡æŸ¥æŠ¥å‘Š

**é¡¹ç›®åç§°**: ç¾Šç¾¤å¼•å¯¼å¼ºåŒ–å­¦ä¹  (Sheep Herding RL)  
**å®¡æŸ¥æ—¥æœŸ**: 2026-02-17  
**å®¡æŸ¥èŒƒå›´**: å…¨éƒ¨æ ¸å¿ƒä»£ç   
**å®¡æŸ¥ç‰ˆæœ¬**: ç¬¬ä¸‰æ¬¡å®¡æŸ¥ï¼ˆä¿®å¤åï¼‰

---

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

è¿™æ˜¯ä¸€ä¸ª**ç¾Šç¾¤å¼•å¯¼å¼ºåŒ–å­¦ä¹ é¡¹ç›®**ï¼Œä½¿ç”¨PPOç®—æ³•è®­ç»ƒé«˜å±‚æ§åˆ¶å™¨æ¥æŒ‡å¯¼æœºæ¢°ç‹—å›´å µå’Œå¼•å¯¼ç¾Šç¾¤ã€‚é¡¹ç›®ç»“æ„æ¸…æ™°ï¼ŒåŒ…å«ç¯å¢ƒæ¨¡æ‹Ÿã€PPOç®—æ³•å®ç°ã€ç½‘ç»œæ¶æ„å’Œæµ‹è¯•æ¨¡å—ã€‚

### é¡¹ç›®ç»“æ„

```
high_layer/
â”œâ”€â”€ train_ppo.py              # PPOè®­ç»ƒè„šæœ¬
â”œâ”€â”€ envs/
â”‚   â”œâ”€â”€ sheep_flock.py        # Gymé£æ ¼ç¯å¢ƒ
â”‚   â”œâ”€â”€ sheep_scenario.py     # åœºæ™¯ç®¡ç†
â”‚   â”œâ”€â”€ sheep_entity.py       # ç¾Šå®ä½“(Boidsæ¨¡å‹)
â”‚   â”œâ”€â”€ high_level_action.py  # é«˜å±‚åŠ¨ä½œè§£ç å™¨
â”‚   â”œâ”€â”€ curriculum_env.py     # è¯¾ç¨‹å­¦ä¹ ç¯å¢ƒ
â”‚   â””â”€â”€ __init__.py           # æ¨¡å—å¯¼å‡º
â”œâ”€â”€ onpolicy/
â”‚   â”œâ”€â”€ algorithms/
â”‚   â”‚   â”œâ”€â”€ ppo_actor_critic.py    # Actor-Criticç½‘ç»œ
â”‚   â”‚   â””â”€â”€ utils/
â”‚   â”‚       â”œâ”€â”€ bounded_act.py     # æœ‰ç•ŒåŠ¨ä½œå±‚
â”‚   â”‚       â”œâ”€â”€ mlp.py             # MLPç½‘ç»œ
â”‚   â”‚       â”œâ”€â”€ rnn.py             # RNNç½‘ç»œ
â”‚   â”‚       â”œâ”€â”€ popart.py          # PopArtå½’ä¸€åŒ–
â”‚   â”‚       â””â”€â”€ util.py            # å·¥å…·å‡½æ•°
â”‚   â””â”€â”€ utils/
â”‚       â”œâ”€â”€ ppo_buffer.py          # PPOç»éªŒå›æ”¾ç¼“å†²åŒº
â”‚       â”œâ”€â”€ valuenorm.py           # å€¼å½’ä¸€åŒ–
â”‚       â””â”€â”€ util.py                # å·¥å…·å‡½æ•°
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ test_ppo.py           # PPOå•å…ƒæµ‹è¯•
â”‚   â””â”€â”€ test_env.py           # ç¯å¢ƒå•å…ƒæµ‹è¯•
â””â”€â”€ utils/
    â””â”€â”€ utils.py              # é€šç”¨å·¥å…·å‡½æ•°
```

---

## âœ… å·²ä¿®å¤é—®é¢˜

### ç¬¬ä¸€æ¬¡å®¡æŸ¥ï¼ˆå·²å®Œæˆï¼‰
- [x] Buffer `after_update()` æœªè°ƒç”¨ - train_ppo.py
- [x] `check()` å‡½æ•°è¿”å›å€¼ç¼ºå¤± - onpolicy/utils/util.py
- [x] TanhNormal æ•°å€¼ç¨³å®šæ€§ - bounded_act.py
- [x] ValueNorm å‚æ•°è®¾å¤‡ä¸ä¸€è‡´ - valuenorm.py
- [x] å¥–åŠ±ç¼ºå°‘è¶…æ—¶æƒ©ç½š - sheep_flock.py
- [x] PopArt å‚æ•°æ›´æ–°æ–¹å¼ - popart.py
- [x] è®¾å¤‡å¤„ç†ä»£ç ç°ä»£åŒ– - bounded_act.py
- [x] ç±»å‹æ¯”è¾ƒæ”¹ä¸º isinstance() - å¤šä¸ªæ–‡ä»¶
- [x] æ—¥å¿—æ–‡ä»¶å…³é—­é€»è¾‘ - train_ppo.py

### ç¬¬äºŒæ¬¡å®¡æŸ¥ï¼ˆå·²å®Œæˆï¼‰
- [x] è¯¾ç¨‹å­¦ä¹ ç¯å¢ƒ `action_decoder` æœªæ›´æ–° - curriculum_env.py
- [x] éšæœºåŒ–ç¯å¢ƒ `action_decoder` æœªæ›´æ–° - curriculum_env.py
- [x] è¯¾ç¨‹å­¦ä¹ é˜¶æ®µé…ç½®æ›´æ–° - curriculum_env.py

### ç¬¬ä¸‰æ¬¡å®¡æŸ¥ï¼ˆå·²å®Œæˆï¼‰
- [x] æµ‹è¯•æ–‡ä»¶è§‚æµ‹ç»´åº¦æ–­è¨€ä¿®å¤ - test_env.py

---

## ğŸŸ¡ å‰©ä½™æ”¹è¿›å»ºè®®

### Improvement 1: TanhNormal epsilon ä¸ä¸€è‡´

**æ–‡ä»¶**: `onpolicy/algorithms/utils/bounded_act.py`  
**ä½ç½®**: ç¬¬32è¡Œ, ç¬¬67è¡Œ

**é—®é¢˜æè¿°**:
`TanhNormal` ç±»ä¸­å®šä¹‰äº† `self._eps = 1e-6`ï¼Œä½† `_inverse_tanh` æ–¹æ³•ä¸­ä½¿ç”¨ç¡¬ç¼–ç çš„ `eps = 1e-6`ï¼Œåº”ä¿æŒä¸€è‡´ã€‚

**ä¿®å¤å»ºè®®**:
```python
def _inverse_tanh(self, y):
    y = y.clamp(-1 + self._eps, 1 - self._eps)
```

---

### Improvement 2: åæ–¹å·®çŸ©é˜µè¾¹ç•Œæƒ…å†µå¤„ç†

**æ–‡ä»¶**: `envs/sheep_scenario.py`  
**ä½ç½®**: ç¬¬242-243è¡Œ

**é—®é¢˜æè¿°**:
å½“ç¾Šç¾¤åªæœ‰2åªç¾Šæ—¶ï¼Œ`np.cov(centered.T)` å¯èƒ½è¿”å›æ ‡é‡è€ŒéçŸ©é˜µï¼Œéœ€è¦å¤„ç†è¾¹ç•Œæƒ…å†µã€‚

**ä¿®å¤å»ºè®®**:
```python
if centered.shape[0] < 2:
    return 1.0, 1.0

cov_matrix = np.cov(centered.T)
if cov_matrix.ndim == 0:
    return float(cov_matrix), float(cov_matrix)
```

---

### Improvement 3: è®­ç»ƒå™¨ num_herders æœªåŠ¨æ€æ›´æ–°

**æ–‡ä»¶**: `train_ppo.py`  
**ä½ç½®**: ç¬¬141è¡Œ

**é—®é¢˜æè¿°**:
`self.num_herders = args.num_herders` åœ¨åˆå§‹åŒ–æ—¶è®¾ç½®ï¼Œä½†å¦‚æœä½¿ç”¨è¯¾ç¨‹å­¦ä¹ æˆ–éšæœºåŒ–ç¯å¢ƒï¼Œ`num_herders` å¯èƒ½ä¼šå˜åŒ–ã€‚

**ä¿®å¤å»ºè®®**:
```python
def _expand_actions_for_herders(self, action):
    num_herders = getattr(self.env, 'num_herders', self.num_herders)
    actions = np.zeros((num_herders, len(action)), dtype=np.float32)
```

---

## ğŸ”µ Nitpicks (å°é—®é¢˜)

### Nitpick 1: é­”æ³•æ•°å­—æœªæå–ä¸ºå¸¸é‡

**æ¶‰åŠæ–‡ä»¶**:
- `envs/sheep_entity.py` ç¬¬143è¡Œ: `evasion_radius: float = 8.0`
- `envs/sheep_scenario.py` ç¬¬80è¡Œ: `spread = 5.0`
- `envs/sheep_flock.py` ç¬¬221-222è¡Œ: `min_herder_distance = 2.0`, `flock_safe_distance = 3.0`

---

### Nitpick 2: æµ‹è¯•è¦†ç›–ä¸å®Œæ•´

ç¼ºå°‘ä»¥ä¸‹æµ‹è¯•:
- è¯¾ç¨‹å­¦ä¹ ç¯å¢ƒæµ‹è¯•
- éšæœºåŒ–ç¯å¢ƒæµ‹è¯•
- é«˜å±‚åŠ¨ä½œè§£ç å™¨æµ‹è¯•
- è¾¹ç•Œæ¡ä»¶æµ‹è¯•

---

## ğŸ“Š ä»£ç è´¨é‡è¯„åˆ†

| ç»´åº¦ | è¯„åˆ† | è¯´æ˜ |
|------|------|------|
| **æ­£ç¡®æ€§** | âœ… 9/10 | ä¸»è¦é—®é¢˜å·²ä¿®å¤ï¼Œå‰©ä½™å°‘é‡è¾¹ç•Œæƒ…å†µ |
| **å¯ç»´æŠ¤æ€§** | âœ… 8/10 | ä»£ç ç»“æ„æ¸…æ™°ï¼Œæ¨¡å—åŒ–è‰¯å¥½ |
| **å¯è¯»æ€§** | âœ… 9/10 | æ³¨é‡Šå……åˆ†ï¼Œå‘½åè§„èŒƒï¼Œæœ‰ä¸­æ–‡æ–‡æ¡£ |
| **æ•ˆç‡** | âœ… 7/10 | åŸºæœ¬åˆç† |
| **å®‰å…¨æ€§** | âœ… 9/10 | æ— æ˜æ˜¾å®‰å…¨æ¼æ´ |
| **æµ‹è¯•è¦†ç›–** | âš ï¸ 7/10 | åŸºç¡€æµ‹è¯•å®Œæ•´ï¼Œç¼ºå°‘æ–°åŠŸèƒ½æµ‹è¯• |

---

## âœ… ä»£ç äº®ç‚¹

1. **æ¸…æ™°çš„æ¨¡å—åŒ–è®¾è®¡**: ç¯å¢ƒã€ç®—æ³•ã€ç½‘ç»œåˆ†ç¦»è‰¯å¥½
2. **Boidsæ¨¡å‹å®ç°å®Œæ•´**: `sheep_entity.py` çš„åˆ†ç¦»ã€å¯¹é½ã€èšåˆè§„åˆ™å®ç°è§„èŒƒ
3. **TanhNormalåˆ†å¸ƒ**: æ­£ç¡®å®ç°äº†æœ‰ç•ŒåŠ¨ä½œç©ºé—´çš„æ¦‚ç‡åˆ†å¸ƒï¼Œæ•°å€¼ç¨³å®šæ€§å·²æ”¹è¿›
4. **GAEæ”¯æŒ**: æ­£ç¡®å®ç°äº†Generalized Advantage Estimation
5. **è¯¾ç¨‹å­¦ä¹ æ”¯æŒ**: æ–°å¢äº†è¯¾ç¨‹å­¦ä¹ å’ŒéšæœºåŒ–ç¯å¢ƒï¼Œæ”¯æŒæ¸è¿›å¼è®­ç»ƒ
6. **é«˜å±‚åŠ¨ä½œè§£ç å™¨**: å®ç°äº†è§’åº¦ç›¸å¯¹åŒ–å’Œvon Misesåˆ†å¸ƒé‡‡æ ·
7. **æ”¹è¿›çš„å¥–åŠ±å‡½æ•°**: åŒ…å«è·ç¦»ã€ç´§å¯†åº¦ã€æ–¹å‘ã€å½¢çŠ¶ç­‰å¤šç»´åº¦å¥–åŠ±

---

## ğŸ“ å½“å‰è¯¾ç¨‹å­¦ä¹ é…ç½®

```
Stage 0: 3 sheep, 3 herders, 30x30 world
Stage 1: 5 sheep, 3 herders, 40x40 world  
Stage 2: 10 sheep, 3 herders, 30x30 world (target)
```

---

## ğŸ“š å‚è€ƒèµ„æ–™

- [PPOè®ºæ–‡](https://arxiv.org/abs/1707.06347)
- [MAPPOä»£ç åº“](https://github.com/marlbenchmark/on-policy)
- [Boidsæ¨¡å‹](https://www.red3d.com/cwr/boids/)
- [PopArtè®ºæ–‡](https://arxiv.org/abs/1602.07714)
- [Curriculum Learning](https://arxiv.org/abs/2101.10382)

---

*æŠ¥å‘Šç”Ÿæˆæ—¶é—´: 2026-02-17*  
*ç¬¬ä¸‰æ¬¡å®¡æŸ¥æ—¶é—´: 2026-02-17*
